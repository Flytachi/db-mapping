<?php

declare(strict_types=1);

namespace Flytachi\DbMapping\Attributes\Sub;

use Attribute;

#[Attribute(Attribute::TARGET_PROPERTY)]
readonly class AutoIncrement implements AttributeDbSubType
{
    /**
     * AutoIncrement attribute for marking a property as an auto-incrementing column.
     *
     * @param bool $always
     *     If true, uses `GENERATED ALWAYS AS IDENTITY` for Postgres.
     *     If false (default), uses `GENERATED BY DEFAULT AS IDENTITY` for Postgres.
     *     Has no effect for MySQL (always uses AUTO_INCREMENT).
     */
    public function __construct(
        private bool $always = false
    ) {
    }

    public function supports(array &$phpTypes): bool
    {
        $phpTypes = array_filter($phpTypes, fn($type) => $type !== 'null');
        if (
            count($phpTypes) === 1
            && in_array($phpTypes[0], ['mixed', 'int'])
        ) {
            return true;
        }
        return false;
    }

    public function toSql(string $type, string $dialect = 'mysql'): string
    {
        if (!in_array($type, ['BIGINT', 'INT', 'SMALLINT'])) {
            throw new \RuntimeException(
                'AutoIncrement invalid type ' . $type
            );
        }
        return match ($dialect) {
            'pgsql' => $type . ($this->always
                ? ' GENERATED ALWAYS AS IDENTITY'
                : ' GENERATED BY DEFAULT AS IDENTITY'
            ),
            'mysql' => $type . ' AUTO_INCREMENT',
        };
    }
}
